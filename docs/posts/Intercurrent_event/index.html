<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yujing Gao">
<meta name="dcterms.date" content="2025-09-15">

<title>SafetyAnalysisBlog - Estimation Methods for Intercurrent Events</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">SafetyAnalysisBlog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Estimation Methods for Intercurrent Events</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">intercurrent event</div>
                <div class="quarto-category">per-protocol method</div>
                <div class="quarto-category">causal inference</div>
                <div class="quarto-category">principal stratification</div>
                <div class="quarto-category">multiple robust</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yujing Gao </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 15, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div style="text-align: justify;">
<section id="the-general-introduction-of-estimand-framework" class="level2">
<h2 class="anchored" data-anchor-id="the-general-introduction-of-estimand-framework">1. The General Introduction of Estimand Framework</h2>
<p>The general introduction of estimand framework includes four parts:</p>
<ul>
<li><p>Trial Objective</p></li>
<li><p>Estimand</p></li>
<li><p>Main Estimator</p></li>
<li><p>Main Estimate</p></li>
</ul>
<p>An <strong>estimand</strong> is a precise description of the treatment effect reflecting the clinical question posed by a given clinical trial objective, via specifying five attributes: Population, Treatment, Endpoint, Population-level Summary, Intercurrent Events.</p>
<p>The <strong>intercurrent event</strong> is an event that occurs after treatment initiation and affects either the interpretation or existence of the measurements associated with the clinical outcome.</p>
<p>There are <strong>five strategies (page 101-118 of ICH E9)</strong> to deal with intercurrent events: treatment policy, hypothetical, composite variable, while on treatment, principal stratum. We will introduce these five strategies in next Section.</p>
</section>
<section id="the-five-strategies" class="level2">
<h2 class="anchored" data-anchor-id="the-five-strategies">2. The Five Strategies</h2>
<section id="treatment-policy" class="level3">
<h3 class="anchored" data-anchor-id="treatment-policy">2.1 Treatment Policy</h3>
<p>The treatment policy strategy includes all post-randomization data, regardless of the intercurrent events. In this approach, the primary analysis treats the occurrence of intercurrent events as part of the real-world scenario. Thus, data is collected and analyzed as if all patients followed the initial treatment assignment, irrespective of deviations. (Intention to treat - ITT)</p>
<p>Example: A clinical trial where patients switch to a different medication due to adverse effects, but all data (pre- and post-switch) are included in the primary analysis.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="stg1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hypothetical" class="level3">
<h3 class="anchored" data-anchor-id="hypothetical">2.2 Hypothetical</h3>
<p>The hypothetical strategy considers what the outcome would have been if the intercurrent event had not occurred. This strategy relies on assumptions to model the data based on a scenario where patients had continued as initially intended, disregarding the actual intercurrent events.</p>
<p>Example: Estimating the effect of a drug assuming that all patients remained on the assigned treatment without any dropouts or additional medications.</p>
<p>The hypothetical scenario should consider reasonable situations, e.g.&nbsp;a scenario where a toxic medicine is considered to be non-toxic is not usually relevant for decision making.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="stg2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="composite-variable" class="level3">
<h3 class="anchored" data-anchor-id="composite-variable">2.3 Composite Variable</h3>
<p>In the composite variable strategy, the intercurrent event is integrated into the outcome itself, redefining it as part of a combined endpoint. This method allows for a new outcome that includes both the clinical endpoint and the intercurrent event, allowing analyses to capture their joint effect.</p>
<p>Example: For a heart disease trial, combining hospitalization and mortality as a composite endpoint, rather than separating them, captures the total adverse outcomes.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="stg3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="while-on-treatment" class="level3">
<h3 class="anchored" data-anchor-id="while-on-treatment">2.4 While-on-Treatment</h3>
<p>The while-on-treatment strategy (also known as the on-treatment strategy) restricts analysis to data collected up until the occurrence of the intercurrent event. Once the intercurrent event occurs, further data is excluded from the analysis. This approach only considers the efficacy of the treatment while patients are actively taking it.</p>
<p>Example: Including data from patients only while they adhere to the medication and excluding data collected after discontinuation or switch to another treatment.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="stg4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="principal-stratum" class="level3">
<h3 class="anchored" data-anchor-id="principal-stratum">2.5 Principal Stratum</h3>
<p>The principal stratum strategy analyzes only a specific subset of patients defined by their response to the intercurrent event, such as those who would not experience the event regardless of the treatment they received. This strategy requires assumptions about which patients would fall into this subset and generally involves a more complex statistical model.</p>
<p>Example: In a study where some patients are likely to need additional therapy, the analysis might focus only on those who would not require additional therapy regardless of the treatment arm they are in.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="stg5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="an-simple-example" class="level2">
<h2 class="anchored" data-anchor-id="an-simple-example">3. An Simple Example</h2>
<p>Primary Estimand: to assess the outcome of new medicine (treatment group) as compared to old medicine (control group) in defined population who complete the treatment regimen.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="simple_exp.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="principal-stratification-framework" class="level2">
<h2 class="anchored" data-anchor-id="principal-stratification-framework">4. Principal Stratification Framework</h2>
<section id="principal-strata" class="level3">
<h3 class="anchored" data-anchor-id="principal-strata">4.1. Principal Strata</h3>
<p>Under the potential outcome framework (Rubin; 1974), each subject has potential outcomes <span class="math inline">\(S(z)\)</span> and <span class="math inline">\(Y(z)\)</span>, where <span class="math inline">\(z=0,1\)</span>. Frangakis and Rubin (2002) defined the principal stratification variable, <span class="math inline">\(U=S(1)S(0)\)</span>, where <span class="math inline">\(S(0),S(1)\in\{0,1\}\)</span>. Thus, there are four principal strata:</p>
<ul>
<li><p><span class="math inline">\(U=00\)</span>: Never-adherence</p></li>
<li><p><span class="math inline">\(U=10\)</span>: Treatment-benefit adherence</p></li>
<li><p><span class="math inline">\(U=01\)</span>: Control-benefit adherence</p></li>
<li><p><span class="math inline">\(U=11\)</span>: Always-adherence</p></li>
</ul>
<p>Take <span class="math inline">\(U=S(1)S(0) = 00\)</span> Never-adherence as an example:</p>
<ul>
<li><p><span class="math inline">\(S(1) = 0\)</span>: when subject is assigned to the treatment group, she/he will not adhere to the protocol.</p></li>
<li><p><span class="math inline">\(S(0) = 0\)</span>: when subject is assigned to the control group, she/he will not adhere to the protocol.</p></li>
</ul>
<p>Below we show the relationship between principal strata and the observed strata.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="relationship.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="principal-causal-effects-pces" class="level3">
<h3 class="anchored" data-anchor-id="principal-causal-effects-pces">4.2. Principal Causal Effects (PCEs)</h3>
<p>The causal estimand here is defined as principal causal effects (PCEs): <span class="math display">\[\tau_{U=S(1)S(0)} = E\{Y(1) - Y(0) | U = S(1)S(0)\},\quad S(1)S(0) = 00, 10, 11, 01.\]</span></p>
<p>In Section 2’s example, our interested parameter is PCE in Always-adherence strata: <span class="math display">\[\tau_{11} = \tau_{U=11} = E\{Y(1) - Y(0)| U= 11\}.\]</span></p>
</section>
<section id="per-protocol-method" class="level3">
<h3 class="anchored" data-anchor-id="per-protocol-method">4.3. Per-protocol Method</h3>
<p>Here we also list the target estimand in Per-protocol method using our notation: <span class="math display">\[\tau_{pp} = E(Y|Z=1,S=1) - E(Y|Z=0,S=1)\]</span></p>
<p>In Section 2’s example, the interested parameter in the Per-protocol method corresponding to PCE in Always-adherence strata is: <span class="math display">\[\tau_{11} = \tau_{U=11} = E\{Y(1) - Y(0)| U= 11\}.\]</span></p>
<p>However, <span class="math inline">\(\tau_{11}\)</span> is defined on the potential principal strata <span class="math inline">\(U=S(1)S(0) = 11\)</span>, while <span class="math inline">\(\tau_{pp}\)</span> is defined on the observed strata <span class="math inline">\((Z,S)\)</span>.</p>
<p>Here we can use a simple table to show the relationship between principal strata abd observed strata:</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="simple_table.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Thus, if we use the Per-protocol method to estimate <span class="math inline">\(\tau_{11}\)</span>, <span class="math inline">\(\widehat{\tau}_{pp}\)</span> may not be an consistent estimator for <span class="math inline">\(\tau_{11}\)</span> since it will be confounded by two other principal strata <span class="math inline">\(U = 01\)</span> and <span class="math inline">\(U=10\)</span>.</p>
</section>
</section>
<section id="principal-stratification-estimation-methods" class="level2">
<h2 class="anchored" data-anchor-id="principal-stratification-estimation-methods">5. Principal Stratification Estimation Methods</h2>
<section id="identification-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="identification-assumptions">5.1 Identification Assumptions</h3>
<p>We first represent the identification assumptions for the principal causal effects (Jiang et al.; 2022).</p>
<ul>
<li><p><strong>Assumption 1</strong>: SUTVA (Stable Unit Treatment Value Assumption): There is no interference and no hidden variations of treatment.</p>
<ul>
<li>This assumption hold in the completely randomized trial.</li>
</ul></li>
<li><p><strong>Assumption 2</strong>: Treatment Ignorability: <span class="math inline">\(Z\perp \{S(0), S(1), Y(0), Y(1)\}| \boldsymbol{X}\)</span>.</p>
<ul>
<li>This assumption hold in the completely randomized trial.</li>
</ul></li>
<li><p><strong>Assumption 3</strong>: Monotonicity: <span class="math inline">\(S(1)\geq S(0)\)</span>.</p>
<ul>
<li>This rules out stratum U=01 (Control-benefit adherence).</li>
<li>This means: when participants are assigned to the treatment group, they are more likely to adhere to protocol comparing with when participants are assigned to the control group.</li>
<li>Under Assumption 3, the relationship table between the principal strata and the observed strata changed.</li>
<li>Now <span class="math inline">\(\tau_{pp}\)</span> is still confounded by the principal strata <span class="math inline">\(U=10\)</span>.</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="relationship1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p><strong>Assumption 4</strong>: Principal Ignorability: <span class="math display">\[E\{Y(1) | U=11, \boldsymbol{X}\} = E\{Y(1) | U=10, \boldsymbol{X}\} \]</span> <span class="math display">\[E\{Y(0) | U=00, \boldsymbol{X}\} = E\{Y(0) | U=10, \boldsymbol{X}\} \]</span></p>
<ul>
<li>This requires that the expectations of the potential outcome do not vary across some principal strata U conditional on the covariates.</li>
<li>Take the first formula as an example. Under Assumption 1-3, the first formula is equivalent to <span class="math display">\[\begin{align*}
Z=1,S=1:\quad  &amp; E\{Y(1)| U = 11, Z=1,S=1, \boldsymbol{X}\} \\
= &amp;  E\{Y(1)| U = 10, Z=1, S=1, \boldsymbol{X}\}\\
= &amp;  E\{Y | Z=1,S=1,\boldsymbol{X}\}.
\end{align*}\]</span></li>
<li>This assumption help build an bridge to connect observed data with potential outcome. Thus, we can use observed data to estimate the principal causal effect.</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="relationship2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="most-recent-principal-stratification-methods" class="level3">
<h3 class="anchored" data-anchor-id="most-recent-principal-stratification-methods">5.2. Most Recent Principal Stratification Methods:</h3>
<p>Under the identification assumptions listed in Section 5.1, we present the corresponding estimation methods and provide one plot to show the relationship among these methods.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="recent_method.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="notations" class="level4">
<h4 class="anchored" data-anchor-id="notations">5.2.0 Notations</h4>
<p>Before we provide the formula of each estimation method, we first provide the following notation based on the observed data <span class="math inline">\(\boldsymbol{X}\)</span>, <span class="math inline">\(Z\)</span>, <span class="math inline">\(S\)</span>, and <span class="math inline">\(Y\)</span>.</p>
<p>Define:</p>
<ul>
<li><p>the propensity score of <span class="math inline">\(Z\)</span> or the treatment probability given the covariates: <span class="math inline">\(\pi(\boldsymbol{X}) = P(Z=1|\boldsymbol{X})\)</span>.</p></li>
<li><p>the probability of the intermediate variable <span class="math inline">\(S\)</span> conditional on the treatment and covariates: <span class="math inline">\(p_z(\boldsymbol{X}) = P(S=1|Z=z,\boldsymbol{X})\)</span> for <span class="math inline">\(z=0,1\)</span>.</p></li>
<li><p>the principal score of <span class="math inline">\(S\)</span>: <span class="math display">\[
e_{10}(\boldsymbol{X}) = p_1(\boldsymbol{X}) - p_0(\boldsymbol{X}),\quad e_{00}(\boldsymbol{X}) = 1- p_1(\boldsymbol{X}), \quad e_{11}(\boldsymbol{X}) = p_0(\boldsymbol{X}).
\]</span></p></li>
<li><p>the outcome mean within the observed group (<span class="math inline">\(Z=z,S=s\)</span>): <span class="math inline">\(\mu_{zs}(\boldsymbol{X}) = E(Y|Z=z, S=s,\boldsymbol{X})\)</span> for <span class="math inline">\(z,s=0,1\)</span>.</p></li>
<li><p>the marginalized probability of <span class="math inline">\(S\)</span> over the distribution of the covariates: <span class="math inline">\(p_z = E\{p_z(\boldsymbol{X})\}\)</span> for <span class="math inline">\(z=0,1\)</span>.</p></li>
</ul>
</section>
<section id="principal-score-methods-ding-et-al.-2017" class="level4">
<h4 class="anchored" data-anchor-id="principal-score-methods-ding-et-al.-2017">5.2.1 Principal Score Methods (Ding et al.; 2017)</h4>
<p>The two estimators provided in Ding et al.&nbsp;(2017) rely on the principal score model for <span class="math inline">\(S\)</span>, <span class="math inline">\(p(\boldsymbol{X})\)</span>, and the outcome mean model for <span class="math inline">\(Y\)</span>, the linear model fitted by <span class="math inline">\(\beta \boldsymbol{X}\)</span>.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="method1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multiple-robust-methods-jiang-et-al.-2017" class="level4">
<h4 class="anchored" data-anchor-id="multiple-robust-methods-jiang-et-al.-2017">5.2.2 Multiple Robust Methods (Jiang et al.; 2017)</h4>
<p>First, we list two estimators that rely on the propensity score model for Z, <span class="math inline">\(\pi(\boldsymbol{X})\)</span>, and the principal score model for S, <span class="math inline">\(p(\boldsymbol{X})\)</span>.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="method2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Second, we introduce two estimators that rely on the outcome mean model for Y, <span class="math inline">\(\mu(\boldsymbol{X})\)</span>, and the principal score model for S, <span class="math inline">\(p(\boldsymbol{X})\)</span>.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="method3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we present the multiple robust estimator, which relies on all three models: the propensity score model for Z, <span class="math inline">\(\pi(\boldsymbol{X})\)</span>; the principal score model for S, <span class="math inline">\(p(\boldsymbol{X})\)</span>; the outcome mean model for Y, <span class="math inline">\(\mu(\boldsymbol{X})\)</span>.</p>
<div class="cell" data-layout-align="center" data-paged.print="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="method4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="simple-simulation" class="level2">
<h2 class="anchored" data-anchor-id="simple-simulation">6. Simple Simulation</h2>
<p>In this section, we use an simple simulation to show the codes for these principal stratification estimation methods and the Per-protocol method.</p>
<section id="simulation-setting" class="level3">
<h3 class="anchored" data-anchor-id="simulation-setting">6.1 Simulation Setting</h3>
<p>We follow the setting in Section 2.1, where we have three baseline variables:</p>
<ul>
<li><p><span class="math inline">\(X_1\)</span>: Sex, binary, Bernoulli distribution with probability 0.5 as 1 (female)</p></li>
<li><p><span class="math inline">\(X_2\)</span>: Some transformed variable, binary, Bernoulli distribution with probability 0.8 as 1</p></li>
<li><p><span class="math inline">\(X_3\)</span>: Age, continuous, normal distribution with mean 50 and variance 8</p></li>
</ul>
<p>In addition, we use the logistic model to generate the intercurrent event:</p>
<p><span class="math display">\[P(S=1|Z, \boldsymbol{X}) = logistic(-1 + Z +0.6X_1 - 0.4 X_2 + 0.02*X_3 )\]</span> and we use the linear regression model to generate the observed outcome:</p>
<p><span class="math display">\[ Y = 0.5 - 0.3Z + 0.7S + 0.2X_1 -0.2 X_2 + 0.01X_3 + 0.1X_1Z + 0.01 X_3 S + \epsilon\]</span> where <span class="math inline">\(\epsilon\sim N(0, \sigma^2 = 0.4^2)\)</span>.</p>
<p>Under this simulation setting, we represent the following R code to generate the simulated data.</p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">###################################</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">######  Simulation function  ######</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>S_coef_simu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="co"># intercept,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                 <span class="dv">1</span>, <span class="co"># coef of Z, </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">0.6</span>, <span class="co"># coef of Sex, </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">-</span><span class="fl">0.4</span>, <span class="co"># coef of Trans,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                 <span class="fl">0.02</span> <span class="co"># coef of Age</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>Y_coef_simu <span class="ot">&lt;-</span>  <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="co"># intercept,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">-</span><span class="fl">0.3</span>, <span class="co"># coef of Z</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.7</span>, <span class="co"># coef of S</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.2</span>, <span class="co"># coef of Sex</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">-</span><span class="fl">0.2</span>, <span class="co"># coef of Trans</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.01</span>, <span class="co"># coef of Age</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.1</span>, <span class="co"># coef of Sex * Z</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.01</span> <span class="co"># coef of Age * S </span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on vaccine data, we have 3 baseline covariates:</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#  Sex (binary), transformed variable (binary), age (continuous)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>f_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">200</span><span class="sc">*</span><span class="dv">2</span>, <span class="co"># sample size for two groups</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">123</span>, <span class="co"># random seed</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pi_Z =</span> <span class="fl">0.5</span>, <span class="co"># treatment propensity score: ratio of treatment / control, constant</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">male_p =</span> <span class="fl">0.5</span>, <span class="co"># ratio of male</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trans_p =</span> <span class="fl">0.8</span>, <span class="co"># ratio of transformed variable</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>                  <span class="at">age_mu =</span> <span class="dv">50</span>, <span class="co"># mean of age</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">age_sd =</span> <span class="dv">4</span>, <span class="co"># sd of age</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S_coef =</span> S_coef_simu,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Y_coef =</span> Y_coef_simu, </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Y_sd =</span> <span class="fl">0.4</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate baseline variables</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  Sex <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> male_p) <span class="co"># 1 means male, 0 means female</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  Trans <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> trans_p) </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  Age <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="at">n =</span> N, <span class="at">mean =</span> age_mu, <span class="at">sd =</span> age_sd)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate treatment assignment Z (Z = 1, treatment)</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> pi_Z) </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate intermediate variable (S = 1, adherence)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  XZ_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, N), </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                        Z,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                        Sex,</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>                        Trans,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                        Age),</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrow =</span> N, </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>                        <span class="at">byrow =</span> F)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  S_prob <span class="ot">&lt;-</span>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> XZ_matrix <span class="sc">%*%</span> S_coef))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">apply</span>(S_prob, <span class="dv">1</span>, <span class="cf">function</span>(prob){</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>     <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Generate outcome Y</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  XZS_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, N), </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>                       Z,</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>                       S,</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>                       Sex,</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>                       Trans,</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>                       Age,</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                       Sex <span class="sc">*</span> Z,</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                       Age <span class="sc">*</span> S),</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nrow =</span> N, </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                    <span class="at">byrow =</span> F)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  Y_mu <span class="ot">&lt;-</span> XZS_matrix <span class="sc">%*%</span> Y_coef </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> Y_mu, <span class="at">sd =</span> Y_sd)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Z,</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>                     Sex,</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>                     Trans,</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                     Age,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>                     S,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>                     Y</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>data_simu <span class="ot">&lt;-</span> <span class="fu">f_sim</span>(<span class="at">N =</span> <span class="dv">1000</span><span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_simu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Z Sex Trans      Age S         Y
1 1   0     1 47.95359 1 1.3793805
2 0   1     1 50.94775 1 2.6175356
3 1   0     1 47.83364 0 0.2012383
4 0   1     1 54.87691 1 2.2561450
5 1   1     1 50.69654 1 2.2554773
6 1   0     1 47.53893 1 1.4075605</code></pre>
</div>
</div>
</section>
<section id="true-value-calculation" class="level3">
<h3 class="anchored" data-anchor-id="true-value-calculation">6.2 True Value Calculation</h3>
<p>We also provide the code for calculating the true values of both the per-protocol effect <span class="math inline">\(\tau_{pp}\)</span> and each principal causal effect <span class="math inline">\(\tau_{11}\)</span>, <span class="math inline">\(\tau_{10}\)</span>, <span class="math inline">\(\tau_{00}\)</span>.</p>
<p>First, for the true value of the per-protocol method <span class="math inline">\(\tau_{pp}\)</span>, we generate a large simulated data with sample size <span class="math inline">\(10^6\)</span> and then calculate the true value of <span class="math inline">\(\tau_{pp}\)</span> as: <span class="math display">\[\tau_{pp}^{true} = \widehat{E}\{Y|Z=1,S=1\} - \widehat{E}\{Y|Z=0,S=1\}.\]</span></p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data_true <span class="ot">&lt;-</span> <span class="fu">f_sim</span>(<span class="at">N =</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># True value for per-protocol effect</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tau_pp <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">filter</span>(data_true, Z <span class="sc">==</span> <span class="dv">1</span>, S <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>Y) <span class="sc">-</span> <span class="fu">mean</span>(<span class="fu">filter</span>(data_true, Z <span class="sc">==</span> <span class="dv">0</span>, S <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>Y)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tau_pp </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2569127</code></pre>
</div>
</div>
<p>Next, for the true value of the principal causal effects <span class="math inline">\(\tau_{11}\)</span>, <span class="math inline">\(\tau_{10}\)</span> and <span class="math inline">\(\tau_{00}\)</span>. We use the identification result in Theorem 1 provided in Jiang et al.&nbsp;(2022):</p>
<ul>
<li><ol type="a">
<li>Based on the treatment probability and principal score:</li>
</ol></li>
</ul>
<p><span class="math display">\[
Always-adherence: \tau_{11}^{true} =
E\left\{\frac{e_{11}(\boldsymbol{X})}{ p_0} \frac{S}{p_1(\boldsymbol{X})} \frac{Z}{\pi(\boldsymbol{X})} Y\right\} - E\left\{ \frac{S}{p_0} \frac{1-Z}{1-\pi(\boldsymbol{X})} Y\right\}
\]</span></p>
<p><span class="math display">\[
Treatment-benefit-adherence: \tau_{10}^{true} = E\left\{\frac{e_{10}(\boldsymbol{X})}{p_1-p_0} \frac{S}{p_1(\boldsymbol{X})} \frac{Z}{\pi(\boldsymbol{X})} Y \right\} -
E\left\{\frac{e_{10}(\boldsymbol{X})}{p_1-p_0} \frac{1-S}{1-p_0(\boldsymbol{X})} \frac{1-Z}{1 - \pi(\boldsymbol{X})} Y \right\}
\]</span></p>
<p><span class="math display">\[
    Never-adherence: \tau_{00}^{true} = E\left\{\frac{1-S}{1-p_1} \frac{Z}{\pi(\boldsymbol{X})} Y \right\} -
E\left\{\frac{e_{00}(\boldsymbol{X})}{1-p_1}\frac{1-S}{1-p_0(\boldsymbol{X})} \frac{1-Z}{1-\pi(\boldsymbol{X})} Y \right\}
\]</span></p>
<ul>
<li><ol start="2" type="a">
<li>Based on the treatment probability and outcome mean: <span class="math display">\[
Always-adherence: \tau_{11}^{true} =
E\left[\frac{S(1-Z)/ \{1-\pi(\boldsymbol{X})\}}{p_0} \{\mu_{10}(\boldsymbol{X}) - \mu_{00}(\boldsymbol{X})\}\right]
\]</span></li>
</ol></li>
</ul>
<p><span class="math display">\[
Treatment-benefit-adherence: \tau_{10}^{true} =
E\left[ \frac{SZ/\pi(\boldsymbol{X}) - S(1-Z)/\{1-\pi(\boldsymbol{X})\}}{p_1 - p_0} \left\{\mu_{11}(\boldsymbol{X}) - \mu_{00}(\boldsymbol{X})\right\}\right]
\]</span></p>
<p><span class="math display">\[
    Never-adherence: \tau_{00}^{true} = E\left[ \frac{1-SZ/\pi(\boldsymbol{X})}{1-p_1} \{\mu_{11}(\boldsymbol{X}) - \mu_{00}(\boldsymbol{X})\} \right]
\]</span></p>
<ul>
<li><ol start="3" type="a">
<li>Based on the principal score and outcome mean: <span class="math display">\[
Always-adherence: \tau_{11}^{true} = E\left[\frac{p_0(\boldsymbol{X})}{p_0} \{\mu_{11}(\boldsymbol{X}) - \mu_{01}(\boldsymbol{X})\}\right]
\]</span></li>
</ol></li>
</ul>
<p><span class="math display">\[
Treatment-benefit-adherence: \tau_{10}^{true} = E\left[\frac{p_1(\boldsymbol{X}) - p_0(\boldsymbol{X}) }{p_1-p_0} \{\mu_{11}(\boldsymbol{X}) - \mu_{00}(\boldsymbol{X})\} \right]
\]</span></p>
<p><span class="math display">\[
    Never-adherence: \tau_{00}^{true} = E\left[\frac{1-p_1(\boldsymbol{X})}{1-p_1} \{\mu_{10}(\boldsymbol{X}) - \mu_{00}(\boldsymbol{X})\}\right]
\]</span></p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">###### Calculate the true value for PCE ######</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the true value is not stable in this strata</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>tau10 <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S_coef =</span> S_coef_simu,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Y_coef =</span> Y_coef_simu){</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> data<span class="sc">$</span>Z</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> data<span class="sc">$</span>S</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  X1 <span class="ot">&lt;-</span> data<span class="sc">$</span>Sex</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  X2 <span class="ot">&lt;-</span> data<span class="sc">$</span>Trans</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  X3 <span class="ot">&lt;-</span> data<span class="sc">$</span>Age</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  p1_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  p0_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_X)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p0_X)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  e_10_X <span class="ot">&lt;-</span> p1_X <span class="sc">-</span> p0_X</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  e_00_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p1_X</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  e_11_X <span class="ot">&lt;-</span> p0_X</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  mu_11_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  mu_00_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  res_a <span class="ot">&lt;-</span> <span class="fu">mean</span>(e_10_X<span class="sc">*</span>S<span class="sc">*</span>Z<span class="sc">*</span>Y <span class="sc">/</span> (p1<span class="sc">-</span>p0) <span class="sc">/</span> p1_X <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) ) <span class="sc">-</span> </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mean</span>(e_10_X <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>S) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>Z) <span class="sc">*</span> Y <span class="sc">/</span> (p1<span class="sc">-</span>p0) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span>p0_X)<span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  res_b <span class="ot">&lt;-</span> <span class="fu">mean</span>( ((S <span class="sc">*</span> Z <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">-</span> S <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Z) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">*</span> (mu_11_X <span class="sc">-</span> mu_00_X) <span class="sc">/</span> (p1<span class="sc">-</span>p0))</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  res_c <span class="ot">&lt;-</span>  <span class="fu">mean</span>((p1_X <span class="sc">-</span> p0_X) <span class="sc">*</span> (mu_11_X <span class="sc">-</span> mu_00_X) <span class="sc">/</span> (p1 <span class="sc">-</span> p0) )</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(res_a, res_b, res_c))</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>tau00 <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S_coef =</span> S_coef_simu,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Y_coef =</span> Y_coef_simu){</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> data<span class="sc">$</span>Z</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> data<span class="sc">$</span>S</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  X1 <span class="ot">&lt;-</span> data<span class="sc">$</span>Sex</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  X2 <span class="ot">&lt;-</span> data<span class="sc">$</span>Trans</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  X3 <span class="ot">&lt;-</span> data<span class="sc">$</span>Age</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  p1_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  p0_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_X)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p0_X)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  e_00_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p1_X</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  mu_10_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>           Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  mu_00_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>           Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  res_a <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="dv">1</span> <span class="sc">-</span> S)<span class="sc">*</span>Z<span class="sc">*</span>Y <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p1)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">-</span> <span class="fu">mean</span>(e_00_X <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>S)<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Z)<span class="sc">*</span>Y <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span>p1) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span>p0_X)<span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  res_b <span class="ot">&lt;-</span> <span class="fu">mean</span>( (<span class="dv">1</span> <span class="sc">-</span> S<span class="sc">*</span>Z<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> p1) <span class="sc">*</span>  (mu_10_X <span class="sc">-</span> mu_00_X))</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  res_c <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="dv">1</span><span class="sc">-</span>p1_X)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p1) <span class="sc">*</span> (mu_10_X <span class="sc">-</span> mu_00_X) )</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">c</span>(res_a, res_b, res_c))</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>tau11 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S_coef =</span> S_coef_simu,</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Y_coef =</span> Y_coef_simu){</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> data<span class="sc">$</span>Z</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> data<span class="sc">$</span>S</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  X1 <span class="ot">&lt;-</span> data<span class="sc">$</span>Sex</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  X2 <span class="ot">&lt;-</span> data<span class="sc">$</span>Trans</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  X3 <span class="ot">&lt;-</span> data<span class="sc">$</span>Age</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  p1_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  p0_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span> (S_coef[<span class="dv">1</span>] <span class="sc">+</span> S_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> S_coef[<span class="dv">3</span>] <span class="sc">*</span> X1 <span class="sc">+</span> S_coef[<span class="dv">4</span>] <span class="sc">*</span> X2 <span class="sc">+</span> S_coef[<span class="dv">5</span>] <span class="sc">*</span> X3)))</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p1_X)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(p0_X)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  e_11_X <span class="ot">&lt;-</span> p0_X</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  mu_11_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  mu_01_X <span class="ot">&lt;-</span> Y_coef[<span class="dv">1</span>] <span class="sc">+</span> Y_coef[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">3</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">+</span> Y_coef[<span class="dv">4</span>] <span class="sc">*</span> X1 <span class="sc">+</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    Y_coef[<span class="dv">5</span>] <span class="sc">*</span> X2 <span class="sc">+</span> Y_coef[<span class="dv">6</span>] <span class="sc">*</span> X3 <span class="sc">+</span> Y_coef[<span class="dv">7</span>] <span class="sc">*</span> X1 <span class="sc">*</span> <span class="dv">0</span> <span class="sc">+</span> Y_coef[<span class="dv">8</span>] <span class="sc">*</span> X3 <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  res_a <span class="ot">&lt;-</span> <span class="fu">mean</span>(e_11_X<span class="sc">*</span>S<span class="sc">*</span>Z<span class="sc">*</span>Y <span class="sc">/</span> p0 <span class="sc">/</span> p1_X <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) ) <span class="sc">-</span> </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>( S <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>Z) <span class="sc">*</span> Y <span class="sc">/</span> p0 <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  res_b <span class="ot">&lt;-</span> <span class="fu">mean</span>( S<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Z) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) <span class="sc">/</span> p0 <span class="sc">*</span> (mu_11_X <span class="sc">-</span> mu_01_X) )</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  res_c <span class="ot">&lt;-</span>  <span class="fu">mean</span>( p0_X <span class="sc">/</span> p0 <span class="sc">*</span> (mu_11_X <span class="sc">-</span> mu_01_X))</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a> <span class="fu">return</span>(<span class="fu">c</span>(res_a, res_b, res_c))</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>tau11_true <span class="ot">&lt;-</span> <span class="fu">tau11</span>(data_true)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>tau10_true <span class="ot">&lt;-</span> <span class="fu">tau10</span>(data_true)</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>tau00_true <span class="ot">&lt;-</span> <span class="fu">tau00</span>(data_true)</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>tau11_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2465260 -0.2430214 -0.2426083</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tau10_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9491897 0.9423639 0.9459625</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tau00_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2604445 -0.2601612 -0.2607295</code></pre>
</div>
</div>
</section>
<section id="estimation" class="level3">
<h3 class="anchored" data-anchor-id="estimation">6.3 Estimation</h3>
<p>Here we show R codes for principal stratification estimation. First, for the two estimation methods provided by Ding et al.&nbsp;(2017), below is the original R code provided within their paper:</p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ding's original estimation code</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">##################################################################</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">######################## EM Algorithm for ########################</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### Principal Stratification Analysis using Propensity Score ####</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">######################## With Monotonicity #######################</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">###################### Ding and Lu 2015 Oct ######################</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">##################################################################</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">##propensity score method, with covariate adjustment and sensitivity analysis for GPI</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#the package used for multivariate logistic regression</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(nnet)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Preliminary function: principal score calculation </span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Z: randomization</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#D: treatment received</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#X: pretreatment covaraites, 11111 in the first column</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#beta.a, beta.n: initial values for the paramaters in the multiple logistic regression</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#iter.max: total number of iterations</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#error0: convergence error rate</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Trace: if TRUE then trace each EM iteration</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fitting multinomial logistic regression model with principal stratification variable as missing data</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  PS_pred <span class="ot">=</span> <span class="cf">function</span>(Z, D, X, </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">beta.a =</span> <span class="cn">NULL</span>, <span class="at">beta.n =</span> <span class="cn">NULL</span>, </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">iter.max =</span> <span class="dv">200</span>, <span class="at">error0 =</span> <span class="dv">10</span><span class="sc">^-</span><span class="dv">6</span>, <span class="at">Trace =</span> <span class="cn">FALSE</span>) {  </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    V <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">length</span>(Z)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(beta.a)) beta.a <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, V)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(beta.n)) beta.n <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, V)  </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">=</span> <span class="dv">1</span>         </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span>{</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      <span class="do">##initial values of iteration</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      beta.a_old <span class="ot">=</span> beta.a</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      beta.n_old <span class="ot">=</span> beta.n</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(Trace <span class="sc">==</span> T) {</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"The "</span>, iter, <span class="st">"-th EM iteration!"</span>, <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      <span class="co">#E step: posterior probabilities</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>      <span class="co">#and the augmented data set with weights</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">#creat a null matrix for the augmented data set AugData</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>      AugData <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">#each individual correspond to 1 or 2 individuals in the augmented data set</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(Z[i]<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>D[i]<span class="sc">==</span><span class="dv">1</span>) {</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>          <span class="co">#posterior probabilities</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>          prob.c <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="fu">t</span>(beta.a_old)<span class="sc">%*%</span>X[i, ]))</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>          prob.a <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> prob.c</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">1</span>, X[i, ], prob.c))</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">2</span>, X[i, ], prob.a))</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(Z[i]<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>D[i]<span class="sc">==</span><span class="dv">0</span>) {</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">3</span>, X[i, ], <span class="dv">1</span>))  </span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(Z[i]<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>D[i]<span class="sc">==</span><span class="dv">1</span>) {</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">2</span>, X[i, ], <span class="dv">1</span>))  </span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(Z[i]<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>D[i]<span class="sc">==</span><span class="dv">0</span>) {</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>          <span class="co">#posterior probabilities</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>          prob.c <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="fu">t</span>(beta.n_old)<span class="sc">%*%</span>X[i, ]))</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>          prob.n <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> prob.c</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">1</span>, X[i, ], prob.c))</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>          AugData <span class="ot">=</span> <span class="fu">rbind</span>(AugData, <span class="fu">c</span>(<span class="dv">3</span>, X[i, ], prob.n))  </span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        }<span class="co">#for if</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>      }<span class="co">#for "for"</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>      <span class="co">#make AugData into a dataframe</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>      <span class="co">#AugData = data.frame(AugData)</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">#colnames(AugData) = c("U", "X", "Weight")</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>      <span class="co">#Multinomial logistic regression using "nnet" package</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">=</span> <span class="fu">multinom</span>(AugData[, <span class="dv">1</span>] <span class="sc">~</span> AugData[, (<span class="dv">3</span><span class="sc">:</span>(V<span class="sc">+</span><span class="dv">1</span>))], <span class="at">weights =</span> AugData[, (V<span class="sc">+</span><span class="dv">2</span>)], <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>      betas  <span class="ot">=</span> <span class="fu">coef</span>(fit)</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>      beta.a <span class="ot">=</span> betas[<span class="dv">1</span>, ]</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>      beta.n <span class="ot">=</span> betas[<span class="dv">2</span>, ]</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>      iter <span class="ot">=</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>      error <span class="ot">=</span> <span class="fu">sum</span>((beta.a <span class="sc">-</span> beta.a_old)<span class="sc">^</span><span class="dv">2</span>)  <span class="sc">+</span> <span class="fu">sum</span>((beta.n <span class="sc">-</span> beta.n_old)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(iter<span class="sc">&gt;</span>iter.max<span class="sc">||</span>error<span class="sc">&lt;</span>error0)   <span class="cf">break</span>           </span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    }<span class="co">#for repeat</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#the predicted probabilities</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#three columns corresponding to the adherence, always taker and never taker</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    PROB <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, N, <span class="dv">3</span>)</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>      prob.c <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>      prob.a <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">t</span>(beta.a)<span class="sc">%*%</span>X[i, ])</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>      prob.n <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">t</span>(beta.n)<span class="sc">%*%</span>X[i, ])</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>      sum <span class="ot">=</span> prob.c <span class="sc">+</span> prob.a <span class="sc">+</span> prob.n</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>      PROB[i,] <span class="ot">=</span> <span class="fu">c</span>(prob.c, prob.a, prob.n)<span class="sc">/</span>sum</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">=</span> <span class="fu">list</span>(<span class="at">PROB=</span>PROB, <span class="at">beta.a=</span>beta.a, <span class="at">beta.n=</span>beta.n)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(results)</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Main function</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Z: randomization</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">#D: treatment received</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>  <span class="co">#X: covariate matrix: the first column is NOT 11111</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Y: outcome of interest</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">#trc: truncation by death indicator, default FALSE. If TRUE only SACE (i.e. AACE) is calculated.</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ep1, ep0: sensitivity parameters in Proposition 4, Section 6.1.</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">#beta.a, beta.n: initial values for the paramaters in the multiple logistic regression</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  PSPS_M_weighting <span class="ot">=</span> <span class="cf">function</span>(Z, D, X, Y, </span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>                              <span class="at">trc =</span> <span class="cn">FALSE</span>, <span class="at">ep1 =</span> <span class="dv">1</span>, <span class="at">ep0 =</span> <span class="dv">1</span>,</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>                              <span class="at">beta.a =</span> <span class="cn">NULL</span>, <span class="at">beta.n =</span> <span class="cn">NULL</span>) {</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">#augment the design X</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">length</span>(Z)</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="dv">1</span>, N), X)</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">#estimate the propensity scores using Multinomial Logistic Regression</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">#PS_pred returns three columns: c, a, n</span></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>    ps.score.fit <span class="ot">=</span> <span class="fu">PS_pred</span>(Z, D, X, <span class="at">beta.a =</span> beta.a, <span class="at">beta.n =</span> beta.n)</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>    ps.score     <span class="ot">=</span> ps.score.fit<span class="sc">$</span>PROB</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    pr.n <span class="ot">=</span> <span class="fu">sum</span>(Z<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">-</span> D))<span class="sc">/</span><span class="fu">sum</span>(Z)</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    pr.a <span class="ot">=</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> Z)<span class="sc">*</span>D)<span class="sc">/</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">-</span>Z)</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>    pr.c <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> pr.n <span class="sc">-</span> pr.a</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>    <span class="co">#indices</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>    index11 <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>N)[Z<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>D<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>    index10 <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>N)[Z<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>D<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>    index01 <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>N)[Z<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>D<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>    index00 <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>N)[Z<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>D<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">#weights</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>      w1c <span class="ot">=</span> ep1<span class="sc">*</span>ps.score[index11, <span class="dv">1</span>]<span class="sc">/</span>(ep1<span class="sc">*</span>ps.score[index11, <span class="dv">1</span>] <span class="sc">+</span> ps.score[index11, <span class="dv">2</span>])<span class="sc">/</span>pr.c<span class="sc">*</span>(pr.c <span class="sc">+</span> pr.a)</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>      w0c <span class="ot">=</span> ep0<span class="sc">*</span>ps.score[index00, <span class="dv">1</span>]<span class="sc">/</span>(ep0<span class="sc">*</span>ps.score[index00, <span class="dv">1</span>] <span class="sc">+</span> ps.score[index00, <span class="dv">3</span>])<span class="sc">/</span>pr.c<span class="sc">*</span>(pr.c <span class="sc">+</span> pr.n)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>      w0n <span class="ot">=</span> ps.score[index00, <span class="dv">3</span>]<span class="sc">/</span>(ep0<span class="sc">*</span>ps.score[index00, <span class="dv">1</span>] <span class="sc">+</span> ps.score[index00, <span class="dv">3</span>])<span class="sc">/</span>pr.n<span class="sc">*</span>(pr.c <span class="sc">+</span> pr.n)</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    w1a <span class="ot">=</span> ps.score[index11, <span class="dv">2</span>]<span class="sc">/</span>(ep1<span class="sc">*</span>ps.score[index11, <span class="dv">1</span>] <span class="sc">+</span> ps.score[index11, <span class="dv">2</span>])<span class="sc">/</span>pr.a<span class="sc">*</span>(pr.c <span class="sc">+</span> pr.a)</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model assisted regression estimator </span></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>      r1c <span class="ot">=</span> <span class="fu">lm</span>(Y[index11] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index11, ], <span class="at">weights =</span> w1c)<span class="sc">$</span>coef</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>      r0c <span class="ot">=</span> <span class="fu">lm</span>(Y[index00] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index00, ], <span class="at">weights =</span> w0c)<span class="sc">$</span>coef</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>      r1n <span class="ot">=</span> <span class="fu">lm</span>(Y[index10] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index10, ])<span class="sc">$</span>coef</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>      r0n <span class="ot">=</span> <span class="fu">lm</span>(Y[index00] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index00, ], <span class="at">weights =</span> w0n)<span class="sc">$</span>coef</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    r1a <span class="ot">=</span> <span class="fu">lm</span>(Y[index11] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index11, ], <span class="at">weights =</span> w1a)<span class="sc">$</span>coef</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>    r0a <span class="ot">=</span> <span class="fu">lm</span>(Y[index01] <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> X[index01, ])<span class="sc">$</span>coef</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">#weighted outcomes</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>      weighted.Y.c1 <span class="ot">=</span> Y[index11]<span class="sc">*</span>w1c</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>      weighted.Y.c0 <span class="ot">=</span> Y[index00]<span class="sc">*</span>w0c</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>      weighted.Y.n0 <span class="ot">=</span> Y[index00]<span class="sc">*</span>w0n</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>    weighted.Y.a1 <span class="ot">=</span> Y[index11]<span class="sc">*</span>w1a</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>    <span class="co">#CACE, NACE and AACE</span></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>      CACE <span class="ot">=</span> <span class="fu">mean</span>(weighted.Y.c1) <span class="sc">-</span> <span class="fu">mean</span>(weighted.Y.c0)</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>      NACE <span class="ot">=</span> <span class="fu">mean</span>(Y[index10]) <span class="sc">-</span> <span class="fu">mean</span>(weighted.Y.n0)</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>    AACE <span class="ot">=</span> <span class="fu">mean</span>(weighted.Y.a1) <span class="sc">-</span> <span class="fu">mean</span>(Y[index01])</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>    <span class="co">#weighted outcomes for regression estimator</span></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>      weighted.Y1c <span class="ot">=</span> (Y[index11]<span class="sc">-</span>X[index11, ]<span class="sc">%*%</span>r1c)<span class="sc">*</span>w1c</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>      weighted.Y0c <span class="ot">=</span> (Y[index00]<span class="sc">-</span>X[index00, ]<span class="sc">%*%</span>r0c)<span class="sc">*</span>w0c</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>      weighted.Y1n <span class="ot">=</span> Y[index10]<span class="sc">-</span>X[index10, ]<span class="sc">%*%</span>r1n</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>      weighted.Y0n <span class="ot">=</span> (Y[index00]<span class="sc">-</span>X[index00, ]<span class="sc">%*%</span>r0n)<span class="sc">*</span>w0n</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>      weighted.rc <span class="ot">=</span> <span class="fu">rbind</span>(X[index11, ]<span class="sc">*</span>w1c, X[index00, ]<span class="sc">*</span>w0c) <span class="sc">%*%</span> (r1c <span class="sc">-</span> r0c)</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>      weighted.rn <span class="ot">=</span> <span class="fu">rbind</span>(X[index10, ], X[index00, ]<span class="sc">*</span>w0n) <span class="sc">%*%</span> (r1n <span class="sc">-</span> r0n)</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    weighted.Y1a <span class="ot">=</span> (Y[index11]<span class="sc">-</span>X[index11, ]<span class="sc">%*%</span>r1a)<span class="sc">*</span>w1a</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>    weighted.Y0a <span class="ot">=</span> Y[index01]<span class="sc">-</span>X[index01, ]<span class="sc">%*%</span>r0a</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>    weighted.ra <span class="ot">=</span> <span class="fu">rbind</span>(X[index11, ]<span class="sc">*</span>w1a, X[index01, ]) <span class="sc">%*%</span> (r1a <span class="sc">-</span> r0a)</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>    <span class="co">#CACE, NACE and AACE, regression estimates</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>      CACE.reg <span class="ot">=</span> <span class="fu">mean</span>(weighted.Y1c) <span class="sc">-</span> <span class="fu">mean</span>(weighted.Y0c) <span class="sc">+</span> <span class="fu">mean</span>(weighted.rc)</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>      NACE.reg <span class="ot">=</span> <span class="fu">mean</span>(weighted.Y1n) <span class="sc">-</span> <span class="fu">mean</span>(weighted.Y0n) <span class="sc">+</span> <span class="fu">mean</span>(weighted.rn)</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>    AACE.reg <span class="ot">=</span> <span class="fu">mean</span>(weighted.Y1a) <span class="sc">-</span> <span class="fu">mean</span>(weighted.Y0a) <span class="sc">+</span> <span class="fu">mean</span>(weighted.ra)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>    <span class="co">#results</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trc <span class="sc">==</span> F) {</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>      ACE <span class="ot">=</span> <span class="fu">list</span>(<span class="at">CACE =</span> CACE, <span class="at">CACE.reg =</span> CACE.reg, </span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>                 <span class="at">NACE =</span> NACE, <span class="at">NACE.reg =</span> NACE.reg, </span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>                 <span class="at">AACE =</span> AACE, <span class="at">AACE.reg =</span> AACE.reg,  </span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>                 <span class="at">beta.a =</span> ps.score.fit<span class="sc">$</span>beta.a, <span class="at">beta.n =</span> ps.score.fit<span class="sc">$</span>beta.n)</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>      ACE <span class="ot">=</span> <span class="fu">list</span>(<span class="at">AACE =</span> AACE, <span class="at">AACE.reg =</span> AACE.reg,  </span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>                 <span class="at">beta.a =</span> ps.score.fit<span class="sc">$</span>beta.a, <span class="at">beta.n =</span> ps.score.fit<span class="sc">$</span>beta.n)</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(ACE)</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given their estimation functions, we use the simulated data <strong><em>data_simu</em></strong> to show the application</p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>res_PS <span class="ot">&lt;-</span> <span class="fu">PSPS_M_weighting</span>(<span class="at">Z =</span> data_simu<span class="sc">$</span>Z, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">D =</span> data_simu<span class="sc">$</span>S, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">X =</span> <span class="fu">as.matrix</span>(data_simu[, <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]), </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">Y =</span> data_simu<span class="sc">$</span>Y,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">trc =</span> <span class="cn">FALSE</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ep1 =</span> <span class="dv">1</span>, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ep0 =</span> <span class="dv">1</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">beta.a =</span> <span class="cn">NULL</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">beta.n =</span> <span class="cn">NULL</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>res_PS_11 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_PS<span class="sc">$</span>AACE, res_PS<span class="sc">$</span>AACE.reg)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>res_PS_10 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_PS<span class="sc">$</span>CACE, res_PS<span class="sc">$</span>CACE.reg)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>res_PS_00 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_PS<span class="sc">$</span>NACE, res_PS<span class="sc">$</span>NACE.reg)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>res_PS_11</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2007091 -0.2256450</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>res_PS_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9685365 0.9630745</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>res_PS_00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2255630 -0.2216478</code></pre>
</div>
</div>
<p>Next, we present the R code for the five estimation methods provided by Jiang et al.&nbsp;(2022), which is in their R pcakge <strong><em>pace</em></strong>. This package can be installed using the following R code and can be found on web page <a href="https://github.com/shuyang-stat/pace" class="uri">https://github.com/shuyang-stat/pace</a>.</p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"shuyang1987/pace"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pace)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>res_MR <span class="ot">&lt;-</span>  pace<span class="sc">::</span><span class="fu">pace</span>(<span class="at">X =</span> <span class="fu">as.matrix</span>(data_simu[, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)]),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Z =</span> data_simu<span class="sc">$</span>Z,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">S =</span> data_simu<span class="sc">$</span>S,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Y =</span> data_simu<span class="sc">$</span>Y,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family.Y=</span><span class="st">"gaussian"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nboot =</span> <span class="dv">500</span> <span class="co"># bootstrap times</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>res_MR_11 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_MR<span class="sc">$</span>tau11w, res_MR<span class="sc">$</span>tau11sw, res_MR<span class="sc">$</span>tau11reg, res_MR<span class="sc">$</span>tau11reg2, res_MR<span class="sc">$</span>tau11aw)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>res_MR_11</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2365232 -0.2252102 -0.2243740 -0.2243929 -0.2242910</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>res_MR_10 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_MR<span class="sc">$</span>tau10w, res_MR<span class="sc">$</span>tau10sw, res_MR<span class="sc">$</span>tau10reg, res_MR<span class="sc">$</span>tau10reg2, res_MR<span class="sc">$</span>tau10aw)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>res_MR_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9878232 0.9839751 0.9863116 0.9854472 0.9856981</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res_MR_00 <span class="ot">&lt;-</span> <span class="fu">c</span>(res_MR<span class="sc">$</span>tau00w, res_MR<span class="sc">$</span>tau00sw, res_MR<span class="sc">$</span>tau00reg, res_MR<span class="sc">$</span>tau00reg2, res_MR<span class="sc">$</span>tau00aw)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>res_MR_00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2122643 -0.2163912 -0.2184721 -0.2192499 -0.2191100</code></pre>
</div>
</div>
<p>Now let’s combine these 7 estimation results together.</p>
<div class="cell" data-paged.print="false">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>Est_res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">est_method =</span> <span class="fu">c</span>(<span class="st">"Ding_naive"</span>, <span class="st">"Ding_reg"</span>, </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"tau_w"</span>, <span class="st">"tau_sw"</span>, <span class="st">"tau_reg"</span>, <span class="st">"rau_reg2"</span>, <span class="st">"tau_aw"</span>),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau11_est =</span> <span class="fu">c</span>(res_PS_11, res_MR_11),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau11_bias =</span> <span class="fu">c</span>(res_PS_11, res_MR_11) <span class="sc">-</span> tau11_true,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau10_est =</span> <span class="fu">c</span>(res_PS_10, res_MR_10),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau10_bias =</span> <span class="fu">c</span>(res_PS_10, res_MR_10) <span class="sc">-</span> tau10_true,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau00_est =</span> <span class="fu">c</span>(res_PS_00, res_MR_11),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tau00_bias =</span> <span class="fu">c</span>(res_PS_00, res_MR_11) <span class="sc">-</span> tau00_true)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(Est_res, <span class="at">caption =</span> <span class="st">"Estimation Result"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Estimation Result</caption>
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">est_method</th>
<th style="text-align: right;">tau11_est</th>
<th style="text-align: right;">tau11_bias</th>
<th style="text-align: right;">tau10_est</th>
<th style="text-align: right;">tau10_bias</th>
<th style="text-align: right;">tau00_est</th>
<th style="text-align: right;">tau00_bias</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Ding_naive</td>
<td style="text-align: right;">-0.2007091</td>
<td style="text-align: right;">0.0458169</td>
<td style="text-align: right;">0.9685365</td>
<td style="text-align: right;">0.0193468</td>
<td style="text-align: right;">-0.2255630</td>
<td style="text-align: right;">0.0348815</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ding_reg</td>
<td style="text-align: right;">-0.2256450</td>
<td style="text-align: right;">0.0173764</td>
<td style="text-align: right;">0.9630745</td>
<td style="text-align: right;">0.0207106</td>
<td style="text-align: right;">-0.2216478</td>
<td style="text-align: right;">0.0385134</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tau_w</td>
<td style="text-align: right;">-0.2365232</td>
<td style="text-align: right;">0.0060851</td>
<td style="text-align: right;">0.9878232</td>
<td style="text-align: right;">0.0418606</td>
<td style="text-align: right;">-0.2365232</td>
<td style="text-align: right;">0.0242063</td>
</tr>
<tr class="even">
<td style="text-align: left;">tau_sw</td>
<td style="text-align: right;">-0.2252102</td>
<td style="text-align: right;">0.0213158</td>
<td style="text-align: right;">0.9839751</td>
<td style="text-align: right;">0.0347854</td>
<td style="text-align: right;">-0.2252102</td>
<td style="text-align: right;">0.0352343</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tau_reg</td>
<td style="text-align: right;">-0.2243740</td>
<td style="text-align: right;">0.0186474</td>
<td style="text-align: right;">0.9863116</td>
<td style="text-align: right;">0.0439477</td>
<td style="text-align: right;">-0.2243740</td>
<td style="text-align: right;">0.0357872</td>
</tr>
<tr class="even">
<td style="text-align: left;">rau_reg2</td>
<td style="text-align: right;">-0.2243929</td>
<td style="text-align: right;">0.0182154</td>
<td style="text-align: right;">0.9854472</td>
<td style="text-align: right;">0.0394846</td>
<td style="text-align: right;">-0.2243929</td>
<td style="text-align: right;">0.0363366</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tau_aw</td>
<td style="text-align: right;">-0.2242910</td>
<td style="text-align: right;">0.0222351</td>
<td style="text-align: right;">0.9856981</td>
<td style="text-align: right;">0.0365084</td>
<td style="text-align: right;">-0.2242910</td>
<td style="text-align: right;">0.0361535</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="reference" class="level2">
<h2 class="anchored" data-anchor-id="reference">Reference</h2>
<ul>
<li>D. B. Rubin. Estimating causal effects of treatments in randomized and nonrandomized studies. J Educ Psychol, 66(5): 688–701, 1974.</li>
<li>C.E. Frangakis and D. B. Rubin. Principal stratification in causal inference. Biometrics, 58(1):21–29, 2002.</li>
<li>P. Ding and J. Lu. Principal stratification analysis using principal scores. Journal of the Royal Statistical Society Series B: Statistical Methodology, 79(3):757–777, 2017.</li>
<li>Z. Jiang, S. Yang, and P. Ding. Multiply robust estimation of causal effects under principal ignorability. Journal of the Royal Statistical Society Series B: Statistical Methodology, 84(4):1423–1445, 2022.</li>
</ul>
</section>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>